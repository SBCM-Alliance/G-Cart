<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>G-Cart | ãƒãƒ¼ãƒãƒ£ãƒ«ãƒ»ã‚¼ãƒã‚³ãƒ³</title>
    <!-- Stlite (Serverless Streamlit) Loader -->
    <script src="https://cdn.jsdelivr.net/npm/@stlite/mountable@0.50.0/build/stlite.js"></script>
  </head>
  <body>
    <!-- Streamlit App Container -->
    <div id="root"></div>

    <script>
      stlite.mount(
        {
          requirements: ["streamlit", "pandas", "plotly"], // å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒª
          entrypoint: "app.py", // å®Ÿè¡Œã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«å
          files: {
            "app.py": `
import streamlit as st
import pandas as pd
import plotly.express as px
import time
import random
from datetime import datetime, timedelta

# --- 0. ã‚¢ãƒ—ãƒªè¨­å®š ---
st.set_page_config(
    page_title="G-Cart | ãƒãƒ¼ãƒãƒ£ãƒ«ãƒ»ã‚¼ãƒã‚³ãƒ³",
    page_icon="ğŸ—ï¸",
    layout="wide"
)

# ==========================================
# âš™ï¸ è¨­å®šã‚¨ãƒªã‚¢
# ==========================================

# 1. Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ (CSV URL)
# â€» ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿URLã§ã™ã€‚è‡ªèº«ã®URLãŒã‚ã‚Œã°å·®ã—æ›¿ãˆã¦ãã ã•ã„ã€‚
SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQtWE10eHmfLAKN-RmoNYL1Ypjt0C7XallxW3ilRrqphFloElxE7BPq32SzvNk5T2glaLcsSwcblH6w/pub?gid=0&single=true&output=csv"

# 2. ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ 
FORM_URL = "https://forms.google.com/example"

# 3. ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ (ã‚ãªãŸ)
MY_COMPANY = {
    "name": "å‡ºæœ¨æ‰åœŸæœ¨å·¥æ¥­ (ã‚ãªãŸ)",
    "location": "æŸå¸‚",
    "capacity": 30000000,
}

# 4. å…¬å…±äº‹æ¥­æ¡ˆä»¶ãƒªã‚¹ãƒˆ
PROJECTS = [
    {
        "id": 101,
        "name": "å¸‚é“123å·ç·š èˆ—è£…æ”¹ä¿®å·¥äº‹",
        "location": "æŸå¸‚ãƒ»åŒ—ã‚¨ãƒªã‚¢",
        "budget": 50000000,
        "image": "ğŸš§",
        "tags": ["èˆ—è£…", "è­¦å‚™"],
        "desc": "ç”Ÿæ´»é“è·¯ã®è€æœ½åŒ–ã«ä¼´ã†å…¨é¢èˆ—è£…ã€‚å·¥æœŸ3ãƒ¶æœˆã€‚"
    },
    {
        "id": 102,
        "name": "æŸã®è‘‰å…¬åœ’ å…¬è¡†ãƒˆã‚¤ãƒ¬æ–°è¨­",
        "location": "æŸå¸‚ãƒ»è¥¿ã‚¨ãƒªã‚¢",
        "budget": 80000000,
        "image": "ğŸš½",
        "tags": ["å»ºç¯‰", "æ°´é“", "é›»æ°—"],
        "desc": "ãƒãƒªã‚¢ãƒ•ãƒªãƒ¼å¯¾å¿œã®å…¬è¡†ãƒˆã‚¤ãƒ¬è¨­ç½®ã€‚"
    },
    {
        "id": 103,
        "name": "å°å­¦æ ¡ é€šå­¦è·¯ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«è¨­ç½®",
        "location": "æŸå¸‚ãƒ»ä¸­å¤®",
        "budget": 15000000,
        "image": "ğŸ›¡ï¸",
        "tags": ["åœŸæœ¨", "è³‡æ"],
        "desc": "å…ç«¥ã®å®‰å…¨ç¢ºä¿ã®ãŸã‚ã®ç·Šæ€¥å·¥äº‹ã€‚"
    }
]

# ==========================================
# ğŸ› ï¸ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯
# ==========================================

@st.cache_data(ttl=60)
def load_partners():
    try:
        # å¤–éƒ¨CSVèª­ã¿è¾¼ã¿ (CORSã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚ã€ãƒ‡ãƒ¢ã§ã¯å¤±æ•—ã—ãŸã‚‰ãƒ€ãƒŸãƒ¼ã‚’ä½¿ã†)
        df = pd.read_csv(SHEET_URL)
        df = df.rename(columns={
            "ä¼šç¤¾å": "name", "å¾—æ„å·¥ç¨®": "type", "ã‚¨ãƒªã‚¢": "location", "æ–½å·¥ä½™åŠ›": "capacity"
        })
        return df.to_dict('records')
    except Exception:
        # ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿
        return [
            {"name": "ç”°ä¸­èˆ—è£…ãƒ­ãƒ¼ãƒ‰", "type": "èˆ—è£…", "location": "æŸå¸‚", "capacity": 30000000},
            {"name": "æŸè­¦å‚™ä¿éšœ", "type": "è­¦å‚™", "location": "æŸå¸‚", "capacity": 5000000},
            {"name": "æ¾æˆ¸é›»æ°—ã‚µãƒ¼ãƒ“ã‚¹", "type": "é›»æ°—", "location": "æ¾æˆ¸å¸‚", "capacity": 20000000},
            {"name": "æµå±±æ°´é“ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹", "type": "æ°´é“", "location": "æµå±±å¸‚", "capacity": 15000000},
            {"name": "ã¡ã°å»ºè¨­è³‡æ", "type": "è³‡æ", "location": "æŸå¸‚", "capacity": 50000000},
        ]

PARTNERS = load_partners()

# --- ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®åˆæœŸåŒ– ---
if 'team' not in st.session_state:
    st.session_state['team'] = []
if 'team_budget' not in st.session_state:
    st.session_state['team_budget'] = MY_COMPANY['capacity']
if 'phase' not in st.session_state:
    st.session_state['phase'] = 'selection'  # selection -> matching -> execution

# ==========================================
# ğŸ“± ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (UI)
# ==========================================

with st.sidebar:
    st.header("G-Cart ãƒ¡ãƒ‹ãƒ¥ãƒ¼")
    st.markdown(f"ğŸ‘¤ **{MY_COMPANY['name']}**")
    st.markdown(f"ğŸ’° ä½™åŠ›: Â¥{MY_COMPANY['capacity']:,}")
    st.divider()
    st.link_button("ğŸ“ ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ", FORM_URL)
    
    if st.session_state['phase'] == 'execution':
        st.success("ğŸ—ï¸ ç¾åœ¨æ–½å·¥ä¸­")

st.title("ğŸ›’ G-Cart (Government Cart)")

# ------------------------------------------------------------------
# ç”»é¢1: å…¬å…±äº‹æ¥­ä¸€è¦§ (Amazoné¢¨)
# ------------------------------------------------------------------
if st.session_state['phase'] == 'selection':
    st.caption("ãƒãƒ¼ãƒãƒ£ãƒ«ãƒ»ã‚¼ãƒã‚³ãƒ³ã‚·ã‚¹ãƒ†ãƒ  powered by SBCM")
    st.subheader("ğŸ“¦ ãŠã™ã™ã‚ã®å…¬å…±äº‹æ¥­")
    
    cols = st.columns(3)
    for i, proj in enumerate(PROJECTS):
        with cols[i % 3]:
            with st.container(border=True):
                st.markdown(f"## {proj['image']}")
                st.markdown(f"**{proj['name']}**")
                st.caption(f"ğŸ“ {proj['location']}")
                st.metric("äºˆç®—", f"Â¥{proj['budget']:,}")
                
                shortage = proj['budget'] - MY_COMPANY['capacity']
                
                if shortage > 0:
                    st.warning(f"âš ï¸ å˜ç‹¬ä¸å¯ (ä¸è¶³ Â¥{shortage:,})")
                    btn_label = "ğŸ¤ ãƒãƒ¼ãƒ çµæˆ"
                    btn_type = "primary"
                else:
                    st.success("âœ… å˜ç‹¬å—æ³¨å¯")
                    btn_label = "å…¥æœ­ã¸é€²ã‚€"
                    btn_type = "secondary"
                
                if st.button(btn_label, key=f"p_{proj['id']}", type=btn_type):
                    st.session_state['selected_project'] = proj
                    st.session_state['team'] = []
                    st.session_state['team_budget'] = MY_COMPANY['capacity']
                    st.session_state['phase'] = 'matching'
                    st.rerun()

# ------------------------------------------------------------------
# ç”»é¢2: ãƒãƒ¼ãƒ ãƒ“ãƒ«ãƒ‡ã‚£ãƒ³ã‚° (Tinderé¢¨)
# ------------------------------------------------------------------
elif st.session_state['phase'] == 'matching':
    p = st.session_state['selected_project']
    
    if st.button("â† ä¸€è¦§ã«æˆ»ã‚‹"):
        st.session_state['phase'] = 'selection'
        st.rerun()
        
    st.markdown("---")
    col_L, col_R = st.columns([1, 1.5])
    
    with col_L:
        st.header(f"{p['image']} {p['name']}")
        st.markdown(f"**äºˆç®—: Â¥{p['budget']:,}**")
        st.markdown(f"**å¿…è¦å·¥ç¨®:** {', '.join(p['tags'])}")
        st.divider()
        
        # ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
        progress = min(1.0, st.session_state['team_budget'] / p['budget'])
        st.progress(progress)
        st.markdown(f"**ç·ã‚­ãƒ£ãƒ‘: Â¥{st.session_state['team_budget']:,}** / å¿…è¦: Â¥{p['budget']:,}")
        
        st.markdown("#### çµæˆãƒ¡ãƒ³ãƒãƒ¼")
        st.text(f"ğŸ‘¤ {MY_COMPANY['name']} (Leader)")
        for member in st.session_state['team']:
            st.text(f"ğŸ¤ {member['name']} ({member['type']})")

        if st.session_state['team_budget'] >= p['budget']:
            st.success("ğŸ‰ ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ã‚¯ãƒªã‚¢ï¼")
            if st.button("ğŸš€ ãƒãƒ¼ãƒãƒ£ãƒ«JVã¨ã—ã¦å…¥æœ­ç¢ºå®š", type="primary", use_container_width=True):
                st.balloons()
                time.sleep(1)
                
                # --- æ–½å·¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®è‡ªå‹•ç”Ÿæˆ (ãƒ¢ãƒƒã‚¯) ---
                start_date = datetime.today()
                schedule_data = []
                
                # è‡ªåˆ†
                schedule_data.append({
                    "Task": "æº–å‚™å·¥ãƒ»åŸºç¤", "Company": MY_COMPANY['name'],
                    "Start": start_date, "Finish": start_date + timedelta(days=10),
                    "Progress": 50, "Status": "ä½œæ¥­ä¸­"
                })
                # ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼
                for i, member in enumerate(st.session_state['team']):
                    start = start_date + timedelta(days=10 + (i*10))
                    schedule_data.append({
                        "Task": f"{member['type']}å·¥äº‹", "Company": member['name'],
                        "Start": start, "Finish": start + timedelta(days=10),
                        "Progress": 0, "Status": "å¾…æ©Ÿä¸­"
                    })
                
                st.session_state['schedule'] = pd.DataFrame(schedule_data)
                st.session_state['phase'] = 'execution' # ç”»é¢é·ç§»
                st.rerun()
        else:
            st.warning(f"ã‚ã¨ Â¥{p['budget'] - st.session_state['team_budget']:,} è¶³ã‚Šã¾ã›ã‚“")

    with col_R:
        st.subheader("ğŸ” AIãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰")
        for partner in PARTNERS:
            if partner['name'] in [m['name'] for m in st.session_state['team']]: continue
            
            is_needed = partner['type'] in p['tags']
            if is_needed:
                with st.container(border=True):
                    c1, c2, c3 = st.columns([2, 1, 1])
                    with c1:
                        st.markdown(f"**{partner['name']}**")
                        st.caption(f"ğŸ”§ {partner['type']} | ğŸ“ {partner['location']}")
                    with c2: st.metric("ä½™åŠ›", f"Â¥{partner['capacity']//10000}ä¸‡")
                    with c3:
                        if st.button("è¿½åŠ ", key=f"add_{partner['name']}"):
                            st.session_state['team'].append(partner)
                            st.session_state['team_budget'] += partner['capacity']
                            st.rerun()

# ------------------------------------------------------------------
# ç”»é¢3: G-Gantt (æ–½å·¥ãƒ»é€²æ—ç®¡ç†) - NEW!
# ------------------------------------------------------------------
elif st.session_state['phase'] == 'execution':
    p = st.session_state['selected_project']
    
    st.title("ğŸ“… G-Gantt ç¾å ´ç®¡ç†")
    st.caption(f"æ¡ˆä»¶: {p['name']} | æ–½å·¥ä¸­ JVãƒ¡ãƒ³ãƒãƒ¼: {len(st.session_state['team'])+1}ç¤¾")
    
    # 1. æ”¯æ‰•ã„ã‚¦ã‚©ãƒ¬ãƒƒãƒˆè¡¨ç¤º
    st.markdown("### ğŸ’° ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»ã‚¦ã‚©ãƒ¬ãƒƒãƒˆ")
    
    # ãƒ¢ãƒƒã‚¯è¨ˆç®—: é€²æ—ç‡ã«å¿œã˜ã¦æ”¯æ‰•ã„æ¸ˆã¿é¡ã‚’è¨ˆç®—
    df_sch = st.session_state['schedule']
    total_tasks = len(df_sch)
    total_prog = df_sch["Progress"].sum()
    paid_amount = int(p['budget'] * (total_prog / (total_tasks * 100)))
    
    w1, w2, w3 = st.columns(3)
    w1.metric("å—æ³¨ç·é¡", f"Â¥{p['budget']:,}")
    w2.metric("å³æ™‚åˆ†é…æ¸ˆã¿", f"Â¥{paid_amount:,}", delta=f"{int(total_prog/total_tasks)}%")
    w3.metric("ãƒ—ãƒ¼ãƒ«æ®‹é«˜", f"Â¥{p['budget'] - paid_amount:,}")
    
    st.divider()

    # 2. ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ (Plotly)
    st.subheader("å·¥ç¨‹è¡¨")
    fig = px.timeline(df_sch, x_start="Start", x_end="Finish", y="Task", color="Status",
                      color_discrete_map={"å®Œäº†": "green", "ä½œæ¥­ä¸­": "orange", "å¾…æ©Ÿä¸­": "gray"},
                      hover_data=["Company", "Progress"])
    fig.update_yaxes(autorange="reversed")
    st.plotly_chart(fig, use_container_width=True)
    
    # 3. ä½œæ¥­å ±å‘Šã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
    st.subheader("ğŸ“ ä½œæ¥­å®Œäº†å ±å‘Š (è«‹æ±‚)")
    
    with st.container(border=True):
        col_rep1, col_rep2 = st.columns([2, 1])
        
        with col_rep1:
            # è‡ªåˆ†ã®ã‚¿ã‚¹ã‚¯ï¼ˆä»Šå›ã¯Ownerã®ã‚¿ã‚¹ã‚¯ï¼‰ã‚’é¸æŠ
            my_tasks = df_sch[df_sch["Company"] == MY_COMPANY['name']]
            target_task = st.selectbox("æ›´æ–°ã™ã‚‹ã‚¿ã‚¹ã‚¯", my_tasks["Task"])
            
            # ç¾åœ¨ã®é€²æ—ã‚’å–å¾—
            curr_val = my_tasks[my_tasks["Task"] == target_task]["Progress"].values[0]
            new_val = st.slider("é€²æ—ç‡ (%)", 0, 100, int(curr_val))
            
        with col_rep2:
            st.write("## ")
            if st.button("æ›´æ–°ã—ã¦å…¥é‡‘ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ", type="primary"):
                # ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                idx = df_sch.index[df_sch["Task"] == target_task].tolist()[0]
                st.session_state['schedule'].at[idx, "Progress"] = new_val
                
                if new_val == 100:
                    st.session_state['schedule'].at[idx, "Status"] = "å®Œäº†"
                    st.balloons()
                    st.success("âœ… å·¥ç¨‹å®Œäº†ï¼ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‹ã‚‰é€é‡‘ã•ã‚Œã¾ã—ãŸã€‚")
                elif new_val > 0:
                    st.session_state['schedule'].at[idx, "Status"] = "ä½œæ¥­ä¸­"
                    st.toast("é€²æ—ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ")
                
                time.sleep(1)
                st.rerun()

    if st.button("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ‚äº† (ãƒ‡ãƒ¢ç”¨ãƒªã‚»ãƒƒãƒˆ)"):
        st.session_state['phase'] = 'selection'
        st.rerun()
`
          },
        },
        document.getElementById("root")
      );
    </script>
  </body>
</html>
